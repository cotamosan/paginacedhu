{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios - Veterinaria</title>
    <link rel="icon" href="{% static 'Images/logo.png' %}"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#33C0F1',
                        secondary: '#1E2D93'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Sidebar -->
  <div class="fixed top-0 left-0 z-20 w-full md:w-80 h-full bg-gradient-to-br from-primary to-secondary text-white p-5 transform -translate-x-full md:translate-x-0 transition-transform duration-300" id="sidebar">
    <img class="h-15 mx-auto mb-2" src="{% static 'Images/logo2.png' %}" alt="Logo" />
    <ul class="space-y-2 text-lg">
            <li><a href="{% url 'gestioncitas' %}" class="block hover:bg-white/20 p-2 rounded transition-colors">Citas Solicitadas</a></li>
            <li><a href="{% url 'registroc' %}" class="block hover:bg-white/20 p-2 rounded transition-colors">Registro Citas</a></li>
            <li><a href="{% url 'usuarios' %}" class="block bg-white/30 hover:bg-white/40 p-2 rounded text-gray-900 transition-colors">Gestión de Usuario</a></li>
            <li><a href="{% url 'Tipdelasemana' %}" class="block hover:bg-white/20 p-2 rounded transition-colors">Modificar Tip de la Semana</a></li>
            <li><a href="{% url 'Galeria' %}" class="block hover:bg-white/20 p-2 rounded transition-colors">Modificar Galería</a></li>
            <li><a href="{% url 'modificarservicio' %}" class="block hover:bg-white/20 p-2 rounded transition-colors">Modificar Servicios</a></li>
            <li><a href="{% url 'backup' %}" class="block hover:bg-white/20 p-2 rounded transition-colors">Copia de seguridad</a></li>
            <li><a href="{% url 'logout' %}" class="block hover:bg-red-500/80 p-2 rounded transition-colors">Cerrar sesión</a></li>
        </ul>
        
        <!-- Información del usuario -->
        <div class="absolute bottom-0 left-0 w-full p-4 bg-white/10 border-t border-white/20">
            <div class="text-center">
                <p class="font-bold">Usuario:</p>
                <p class="text-sm">{{ request.user.nombre_completo }}</p>
            </div>
        </div>
    </div>

    

    <!-- Mobile menu button -->
    <button class="md:hidden fixed top-4 left-4 z-20 bg-primary text-white p-2 rounded-lg shadow-lg" id="mobileMenuBtn">
    <i class="fas fa-bars"></i>
    </button>

    <!-- Overlay for mobile menu -->
    <div class="md:hidden fixed inset-0 bg-black/50 z-10 opacity-0 pointer-events-none transition-opacity duration-300" id="overlay"></div>


    
    <!-- Contenido principal -->
    <div class="md:ml-72 p-6 lg:p-8 min-h-screen">
    <nav class="flex ml-8 mb-9 w-full justify-start">
        <ol class="inline-flex items-center space-x-1 md:space-x-2">
            <li class="inline-flex items-center">
                <a href="{% url 'gestioncitas' %}" class="inline-flex items-center text-sm font-medium text-gray-500 hover:text-blue-600 transition-colors">
                    <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M14.707 7.793a1 1 0 0 0-1.414 0L11 10.086V1.5a1 1 0 0 0-2 0v8.586L6.707 7.793a1 1 0 1 0-1.414 1.414l4 4a1 1 0 0 0 1.416 0l4-4a1 1 0 0 0-.002-1.414Z"/>
                        <path d="M18 12h-2.55l-2.975 2.975a3.5 3.5 0 0 1-4.95 0L4.55 12H2a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-4a2 2 0 0 0-2-2Zm-3 5a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/>
                    </svg>
                    Administrador
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                    </svg>
                    <span class="ml-1 text-sm font-medium text-gray-700 md:ml-2">Gestión de Usuarios</span>
                </div>
            </li>
        </ol>
    </nav>
    
    <h1 class="text-2xl lg:text-3xl font-bold mb-6 text-gray-800 text-center">Gestión de Usuarios Administradores</h1>
    
    <div class="mb-6">
        <!-- Contenedor para centrar el botón de filtrar -->
    <div class="flex justify-center mb-6">
        <button id="btnMostrarFiltros" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg shadow-md transition-colors inline-flex items-center gap-2">
            <i class="fas fa-filter"></i> 
            <span>Filtrar</span>
        </button>
    </div>
        
        <div id="filtrosContainer" class="hidden bg-white p-4 lg:p-6 rounded-lg shadow-md mb-4 transition-all duration-300 ease-in-out">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Documento</label>
                    <input type="text" id="filtroDocumento" placeholder="Buscar por documento..."
                        class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                    <input type="text" id="filtroNombre" placeholder="Buscar por nombre..."
                        class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Correo</label>
                    <input type="text" id="filtroCorreo" placeholder="Buscar por correo..."
                        class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                    <input type="text" id="filtroTelefono" placeholder="Buscar por teléfono..."
                        class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                    <select id="filtroEstado" class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        <option value="">Todos</option>
                        <option value="true">Activo</option>
                        <option value="false">Inactivo</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="btnLimpiarFiltros" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg transition-colors inline-flex items-center gap-2">
                        <i class="fas fa-times"></i> 
                        <span>Limpiar</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow-lg overflow-hidden mx-auto max-w-6xl mt-6">
    <div class="overflow-x-auto">
        <table class="w-full border-collapse text-center">
            <thead>
                <tr class="bg-gray-50">
                    <th class="px-4 py-6 text-sm font-bold text-gray-900 border-b border-gray-200">Documento</th>
                    <th class="px-4 py-6 text-sm font-bold text-gray-900 border-b border-gray-200">Nombre Completo</th>
                    <th class="px-4 py-6 text-sm font-bold text-gray-900 border-b border-gray-200">Correo Electrónico</th>
                    <th class="px-4 py-6 text-sm font-bold text-gray-900 border-b border-gray-200">Teléfono</th>
                    <th class="px-4 py-6 text-sm font-bold text-gray-900 border-b border-gray-200">Estado</th>
                    <th class="px-4 py-6 text-sm font-bold text-gray-900 border-b border-gray-200">Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaCuerpo">
                {% for admin in administradores %}
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-4 py-6 text-lg border-b border-gray-100">{{ admin.documento }}</td>
                    <td class="px-4 py-6 text-lg border-b border-gray-100">{{ admin.nombre_completo }}</td>
                    <td class="px-4 py-6 text-lg border-b border-gray-100">{{ admin.correo_electronico }}</td>
                    <td class="px-4 py-6 text-lg border-b border-gray-100">{{ admin.telefono }}</td>
                    <td class="px-4 py-6 border-b border-gray-100">
                        {% if admin.is_active %}
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Activo</span>
                        {% else %}
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Inactivo</span>
                        {% endif %}
                    </td>
                    <td class="border-b border-gray-100">
                        <div class="flex flex-wrap justify-center gap-2">
                            <button class="btn-editar bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md transition-colors inline-flex items-center gap-1 text-sm" data-documento="{{ admin.documento }}">
                                <i class="fas fa-edit"></i> 
                                <span class="hidden sm:inline">Editar</span>
                            </button>
                            <button class="btn-eliminar bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md transition-colors inline-flex items-center gap-1 text-sm" data-documento="{{ admin.documento }}">
                                <i class="fas fa-trash-alt"></i> 
                                <span class="hidden sm:inline">Eliminar</span>
                            </button>
                            <button class="toggle-estado bg-{{ admin.is_active|yesno:'yellow,green' }}-500 hover:bg-{{ admin.is_active|yesno:'yellow,green' }}-600 text-white px-3 py-1 rounded-md transition-colors inline-flex items-center gap-1 text-sm" data-documento="{{ admin.documento }}">
                                <i class="fas fa-{{ admin.is_active|yesno:'ban,check' }}"></i> 
                                <span class="hidden sm:inline">{{ admin.is_active|yesno:'Desactivar,Activar' }}</span>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="px-4 py-8 text-center text-gray-500">No hay usuarios registrados</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>


    <div class="mt-6 text-center">
        <button id="btnNuevoUsuario" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg shadow-md transition-colors inline-flex items-center gap-2">
            <i class="fas fa-plus-circle"></i> 
            <span>Agregar Nuevo Administrador</span>
        </button>
    </div>
</div>


    <!-- Modal para crear/editar usuario -->
    <div id="usuarioModal" class="fixed inset-0 z-50 hidden overflow-y-auto bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="modalTitle" class="text-xl font-bold text-gray-900">Nuevo Administrador</h2>
                    <button onclick="cerrarModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <form id="usuarioForm" method="POST" class="space-y-6">
                    {% csrf_token %}
                    <input type="hidden" name="documento" id="inputDocumento">
                    
                    <div class="form-group">
                        <label for="inputNombre" class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label>
                        <input type="text" name="nombre_completo" id="inputNombre" required
                            class="w-full border border-gray-300 rounded-md shadow-sm py-3 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                            pattern="[A-Za-záéíóúÁÉÍÓÚñÑ\s]+" title="Solo letras y espacios">
                        <div id="nombreError" class="text-red-500 text-sm mt-1"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="inputCorreo" class="block text-sm font-medium text-gray-700 mb-2">Correo Electrónico *</label>
                        <input type="email" name="correo_electronico" id="inputCorreo" required
                            class="w-full border border-gray-300 rounded-md shadow-sm py-3 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                            pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$" title="Ingrese un correo válido">
                        <div id="correoError" class="text-red-500 text-sm mt-1"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="inputTelefono" class="block text-sm font-medium text-gray-700 mb-2">Teléfono *</label>
                        <input type="tel" name="telefono" id="inputTelefono" required
                            class="w-full border border-gray-300 rounded-md shadow-sm py-3 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                            pattern="[0-9]{7,10}" title="Mínimo 7, máximo 10 números" maxlength="10">
                        <div id="telefonoError" class="text-red-500 text-sm mt-1"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="inputDocumentoLogin" class="block text-sm font-medium text-gray-700 mb-2">Documento (para inicio de sesión) *</label>
                        <input type="text" name="documento_login" id="inputDocumentoLogin" required
                            class="w-full border border-gray-300 rounded-md shadow-sm py-3 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                            pattern="[0-9]{7,10}" title="Solo números (7-10 dígitos)" maxlength="10">
                        <div id="documentoError" class="text-red-500 text-sm mt-1"></div>
                    </div>
                    
                    <!-- Campos de contraseña (solo visibles en creación) -->
                    <div id="passwordFields" class="space-y-6">
                        <div class="form-group relative">
                            <label for="inputPassword" class="block text-sm font-medium text-gray-700 mb-2">Contraseña *</label>
                            <div class="relative">
                                <input type="password" name="password" id="inputPassword" required
                                    class="w-full border border-gray-300 rounded-md shadow-sm py-3 px-4 pr-12 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                                <button type="button" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700" onclick="togglePassword('inputPassword')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div id="passwordError" class="text-red-500 text-sm mt-1"></div>
                        </div>
                        
                        <div class="form-group relative">
                            <label for="inputConfirmPassword" class="block text-sm font-medium text-gray-700 mb-2">Confirmar Contraseña *</label>
                            <div class="relative">
                                <input type="password" name="confirm_password" id="inputConfirmPassword" required
                                    class="w-full border border-gray-300 rounded-md shadow-sm py-3 px-4 pr-12 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                                <button type="button" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700" onclick="togglePassword('inputConfirmPassword')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div id="confirmPasswordError" class="text-red-500 text-sm mt-1"></div>
                        </div>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" name="is_active" id="inputActivo" checked
                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="inputActivo" class="ml-2 block text-sm text-gray-900">Usuario activo</label>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row justify-end gap-3 pt-6 border-t border-gray-200">
                        <button type="button" onclick="cerrarModal()"
                            class="px-6 py-3 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors order-2 sm:order-1">
                            Cancelar
                        </button>
                        <button type="submit" id="submitButton"
                            class="px-6 py-3 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors order-1 sm:order-2">
                            Crear
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="{% static 'JavaScript/GestionUsuarios.js' %}"></script>
    <script src={% static "JavaScript/sienna.js" %}></script>
    <script src={% static "JavaScript/custom.js" %}></script>

    <!-- JavaScript Completo -->
    <script>
        // Variables globales
        let isEditMode = false;
        let currentDocumento = '';
        let timeoutId;
        const delay = 300; // Retardo en ms para la búsqueda en tiempo real

        // Funciones del modal
        function abrirModal() {
            document.getElementById('usuarioModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function cerrarModal() {
            document.getElementById('usuarioModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            resetForm();
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling;
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        // Funciones del formulario
        function resetForm() {
            const form = document.getElementById('usuarioForm');
            form.reset();
            clearErrors();
            
            isEditMode = false;
            currentDocumento = '';
            document.getElementById('modalTitle').textContent = 'Nuevo Administrador';
            document.getElementById('submitButton').textContent = 'Crear';
            
            // Mostrar campos de contraseña y hacerlos requeridos
            document.getElementById('passwordFields').style.display = 'block';
            document.getElementById('inputPassword').required = true;
            document.getElementById('inputConfirmPassword').required = true;
            
            // Habilitar edición de documento
            document.getElementById('inputDocumentoLogin').readOnly = false;
        }

        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.textContent = '';
            });
        }

        // Validación en tiempo real
        document.getElementById('inputDocumentoLogin').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
            if (this.value.length > 10) {
                this.value = this.value.slice(0, 10);
            }
        });

        document.getElementById('inputTelefono').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
            if (this.value.length > 10) {
                this.value = this.value.slice(0, 10);
            }
        });

        document.getElementById('inputNombre').addEventListener('input', function(e) {
            // Permitir solo letras y espacios
            this.value = this.value.replace(/[^A-Za-záéíóúÁÉÍÓÚñÑ\s]/g, '');
        });

        // Funciones para mostrar/ocultar filtros
        document.getElementById('btnMostrarFiltros').addEventListener('click', function() {
            const filtros = document.getElementById('filtrosContainer');
            const icono = this.querySelector('i');
            
            // Alternar visibilidad
            filtros.classList.toggle('hidden');
            
            // Cambiar ícono y estilo del botón
            if (filtros.classList.contains('hidden')) {
                this.classList.remove('bg-blue-600');
                this.classList.add('bg-blue-500');
                icono.classList.remove('fa-times');
                icono.classList.add('fa-filter');
            } else {
                this.classList.remove('bg-blue-500');
                this.classList.add('bg-blue-600');
                icono.classList.remove('fa-filter');
                icono.classList.add('fa-times');
            }
        });

        // Funciones de filtrado
        async function aplicarFiltros() {
            try {
                // Obtener valores de los filtros
                const filtros = {
                    documento: document.getElementById('filtroDocumento').value,
                    nombre: document.getElementById('filtroNombre').value,
                    correo: document.getElementById('filtroCorreo').value,
                    telefono: document.getElementById('filtroTelefono').value,
                    estado: document.getElementById('filtroEstado').value
                };

                // Mostrar carga
                const tbody = document.getElementById('tablaCuerpo');
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> Buscando usuarios...</td></tr>';

                // Construir URL con parámetros
                const params = new URLSearchParams();
                for (const key in filtros) {
                    if (filtros[key]) {
                        params.append(key, filtros[key]);
                    }
                }

                // Hacer la petición AJAX
                const response = await fetch(`/usuarios/?${params.toString()}`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    }
                });

                // Verificar si la respuesta es exitosa
                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    throw new Error(errorData?.error || `Error HTTP: ${response.status}`);
                }

                // Procesar la respuesta
                const data = await response.json();
                
                if (!data.administradores) {
                    throw new Error('Formato de respuesta inesperado');
                }

                // Actualizar la tabla
                actualizarTabla(data.administradores);
                
            } catch (error) {
                console.error('Error en aplicarFiltros:', error);
                
                // Mostrar mensaje de error en la tabla
                document.getElementById('tablaCuerpo').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-red-500">
                            Error: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }


        function actualizarTabla(administradores) {
            const tbody = document.getElementById('tablaCuerpo');
            tbody.innerHTML = '';
            
            if (!administradores || administradores.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            No se encontraron usuarios con los filtros aplicados
                        </td>
                    </tr>
                `;
                return;
            }
            
            administradores.forEach(admin => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-4 py-6 text-lg border-b border-gray-100">${admin.documento}</td>
                    <td class="px-4 py-6 text-lg border-b border-gray-100">${admin.nombre_completo}</td>
                    <td class="px-4 py-6 text-lg border-b border-gray-100">${admin.correo_electronico}</td>
                    <td class="px-4 py-6 text-lg border-b border-gray-100">${admin.telefono}</td>
                    <td class="px-4 py-6 border-b border-gray-100">
                        ${admin.is_active ? 
                            '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Activo</span>' : 
                            '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Inactivo</span>'}
                    </td>
                    <td class="px-4 py-6 border-b border-gray-100">
                        <div class="flex flex-wrap justify-center gap-2">
                            <button class="btn-editar bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md transition-colors inline-flex items-center gap-1 text-sm" data-documento="${admin.documento}">
                                <i class="fas fa-edit"></i> 
                                <span class="hidden sm:inline">Editar</span>
                            </button>
                            <button class="btn-eliminar bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md transition-colors inline-flex items-center gap-1 text-sm" data-documento="${admin.documento}">
                                <i class="fas fa-trash-alt"></i> 
                                <span class="hidden sm:inline">Eliminar</span>
                            </button>
                            <button class="toggle-estado bg-${admin.is_active ? 'yellow' : 'green'}-500 hover:bg-${admin.is_active ? 'yellow' : 'green'}-600 text-white px-3 py-1 rounded-md transition-colors inline-flex items-center gap-1 text-sm" data-documento="${admin.documento}">
                                <i class="fas fa-${admin.is_active ? 'ban' : 'check'}"></i> 
                                <span class="hidden sm:inline">${admin.is_active ? 'Desactivar' : 'Activar'}</span>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Reasignar eventos a los nuevos botones
            asignarEventListeners();
        }

        // Limpiar filtros
        document.getElementById('btnLimpiarFiltros').addEventListener('click', async function() {
            // Limpiar los campos de filtro
            document.getElementById('filtroDocumento').value = '';
            document.getElementById('filtroNombre').value = '';
            document.getElementById('filtroCorreo').value = '';
            document.getElementById('filtroTelefono').value = '';
            document.getElementById('filtroEstado').value = '';
            
            // Mostrar carga
            document.querySelector('tbody').innerHTML = '<tr><td colspan="6" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> Cargando todos los usuarios...</td></tr>';
            
            try {
                // Hacer una nueva petición sin filtros
                const response = await fetch('/usuarios/', {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Error al cargar usuarios');
                }
                
                const data = await response.json();
                actualizarTabla(data.administradores);
                
            } catch (error) {
                console.error('Error al limpiar filtros:', error);
                document.querySelector('tbody').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-red-500">
                            Error al cargar usuarios: ${error.message}
                        </td>
                    </tr>
                `;
            }
        });

        // Event listeners para filtros en tiempo real
        document.getElementById('filtroDocumento').addEventListener('input', function() {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(aplicarFiltros, delay);
        });

        document.getElementById('filtroNombre').addEventListener('input', function() {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(aplicarFiltros, delay);
        });

        document.getElementById('filtroCorreo').addEventListener('input', function() {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(aplicarFiltros, delay);
        });

        document.getElementById('filtroTelefono').addEventListener('input', function() {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(aplicarFiltros, delay);
        });

        document.getElementById('filtroEstado').addEventListener('change', aplicarFiltros);

        // Funciones para asignar event listeners
        function asignarEventListeners() {
            // Delegación de eventos para elementos dinámicos
            document.addEventListener('click', function(e) {
                // Editar
                if (e.target.closest('.btn-editar')) {
                    cargarUsuarioParaEditar(e.target.closest('.btn-editar').dataset.documento);
                }
                // Eliminar
                else if (e.target.closest('.btn-eliminar')) {
                    eliminarUsuario(e.target.closest('.btn-eliminar').dataset.documento);
                }
                // Cambiar estado
                else if (e.target.closest('.toggle-estado')) {
                    toggleEstadoUsuario(e.target.closest('.toggle-estado').dataset.documento);
                }
            });
        }

        // Funciones de negocio
        async function cargarUsuarioParaEditar(documento) {
            try {
                const response = await fetch(`/usuarios/editar/${documento}/`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}`);
                }
                
                const data = await response.json();

                // Configurar modal en modo edición
                isEditMode = true;
                currentDocumento = documento;
                document.getElementById('modalTitle').textContent = 'Editar Administrador';
                document.getElementById('submitButton').textContent = 'Actualizar';
                
                // Llenar formulario
                document.getElementById('inputDocumento').value = data.documento;
                document.getElementById('inputNombre').value = data.nombre_completo;
                document.getElementById('inputCorreo').value = data.correo_electronico;
                document.getElementById('inputTelefono').value = data.telefono;
                document.getElementById('inputDocumentoLogin').value = data.documento;
                document.getElementById('inputActivo').checked = data.is_active;
                
                // Ocultar campos de contraseña en edición
                document.getElementById('passwordFields').style.display = 'none';
                document.getElementById('inputPassword').required = false;
                document.getElementById('inputConfirmPassword').required = false;
                
                // Bloquear edición de documento
                document.getElementById('inputDocumentoLogin').readOnly = true;
                
                abrirModal();
            } catch (error) {
                console.error('Error al cargar usuario:', error);
                Swal.fire('Error', 'No se pudieron cargar los datos del usuario', 'error');
            }
        }

        async function eliminarUsuario(documento) {
            try {
                const usuarioActual = "{{ request.user.documento }}"; // Obtener documento del usuario logueado
                
                // Mensaje diferente si intenta eliminarse a sí mismo
                const mensajeConfirmacion = (documento === usuarioActual) 
                    ? "Si eliminas tu cuenta, se cerrará la sesión automáticamente y no podras volver a ingresar. ¿Deseas continuar?"
                    : "¡No podrás revertir esta acción!";

                const result = await Swal.fire({
                    title: '¿Estás seguro?',
                    html: mensajeConfirmacion,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar'
                });

                if (result.isConfirmed) {
                    const response = await fetch(`/usuarios/eliminar/${documento}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json',
                        },
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Error ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Eliminar la fila de la tabla sin recargar
                        const fila = document.querySelector(`.btn-eliminar[data-documento="${documento}"]`).closest('tr');
                        fila.remove();
                        
                        // Mostrar mensaje de éxito
                        await Swal.fire({
                            icon: 'success',
                            title: '¡Eliminado!',
                            text: 'El usuario ha sido eliminado correctamente',
                            confirmButtonText: 'Aceptar'
                        });
                        
                        // Si se eliminó a sí mismo, redirigir al login
                        if (documento === usuarioActual) {
                            window.location.href = "{% url 'logout' %}";
                        }
                        
                        // Si la tabla queda vacía, mostrar mensaje
                        if (document.querySelector('tbody').children.length === 0) {
                            document.querySelector('tbody').innerHTML = `
                                <tr>
                                    <td colspan="6" class="text-center py-4">No hay usuarios registrados</td>
                                </tr>
                            `;
                        }
                    } else {
                        throw new Error(data.message || 'Error al eliminar el usuario');
                    }
                }
            } catch (error) {
                console.error('Error al eliminar usuario:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'No se pudo eliminar el usuario',
                    confirmButtonText: 'Entendido'
                });
            }
        }

        function validarFormulario() {
            let isValid = true;
            clearErrors();

            // Validar campos requeridos (todos menos contraseña en edición)
            const camposRequeridos = [
                'inputNombre', 'inputCorreo', 
                'inputTelefono', 'inputDocumentoLogin'
            ];

            // Validaciones específicas
            const nombre = document.getElementById('inputNombre').value;
            if (nombre && !/^[A-Za-záéíóúÁÉÍÓÚñÑ\s]+$/.test(nombre)) {
                document.getElementById('nombreError').textContent = 'Solo se permiten letras y espacios';
                isValid = false;
            }

            const documento = document.getElementById('inputDocumentoLogin').value;
            if (documento && !/^\d{7,10}$/.test(documento)) {
                document.getElementById('documentoError').textContent = 'Documento debe tener 7-10 dígitos';
                isValid = false;
            }

            const telefono = document.getElementById('inputTelefono').value;
            if (telefono && !/^\d{7,10}$/.test(telefono)) {
                document.getElementById('telefonoError').textContent = 'Teléfono debe tener 7-10 dígitos';
                isValid = false;
            }

            const email = document.getElementById('inputCorreo').value;
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                document.getElementById('correoError').textContent = 'Ingrese un correo válido';
                isValid = false;
            }

            // Solo validar contraseñas en modo creación
            if (!isEditMode) {
                camposRequeridos.push('inputPassword', 'inputConfirmPassword');
                
                const password = document.getElementById('inputPassword').value;
                const confirmPassword = document.getElementById('inputConfirmPassword').value;
                
                if (password.length < 8) {
                    document.getElementById('passwordError').textContent = 'Mínimo 8 caracteres';
                    isValid = false;
                }
                
                if (password !== confirmPassword) {
                    document.getElementById('confirmPasswordError').textContent = 'Las contraseñas no coinciden';
                    isValid = false;
                }
            }

            // Validar campos requeridos
            camposRequeridos.forEach(id => {
                const campo = document.getElementById(id);
                if (!campo.value.trim()) {
                    document.getElementById(`${id}Error`).textContent = 'Campo obligatorio';
                    isValid = false;
                }
            });

            return isValid;
        }

        async function enviarFormulario() {
            if (!validarFormulario()) return;

            const formData = new FormData(document.getElementById('usuarioForm'));
            const url = isEditMode 
                ? `/usuarios/editar/${currentDocumento}/` 
                : `/usuarios/crear/`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || `Error ${response.status}`);
                }

                if (data.success) {
                    Swal.fire({
                        title: '¡Éxito!',
                        text: isEditMode ? 'Usuario actualizado correctamente' : 'Usuario creado correctamente',
                        icon: 'success'
                    }).then(() => {
                        cerrarModal();
                        window.location.reload();
                    });
                } else if (data.errors) {
                    // Mostrar errores de validación del servidor
                    Object.entries(data.errors).forEach(([field, message]) => {
                        const errorElement = document.getElementById(`${field}Error`);
                        if (errorElement) {
                            errorElement.textContent = message;
                        }
                    });
                }
            } catch (error) {
                console.error('Error al enviar formulario:', error);
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'Ocurrió un error al procesar la solicitud',
                    icon: 'error'
                });
            }
        }

        async function toggleEstadoUsuario(documento) {
            try {
                const usuarioActual = "{{ request.user.documento }}";
                const esUsuarioActual = (documento === usuarioActual);
                const accion = document.querySelector(`.toggle-estado[data-documento="${documento}"]`).textContent.trim();
                
                // Mensaje personalizado para auto-desactivación
                let mensajeConfirmacion = `¿Deseas ${accion.toLowerCase()} este usuario?`;
                
                if (esUsuarioActual && accion.includes("Desactivar")) {
                    mensajeConfirmacion = "Si desactivas tu cuenta, se cerrará la sesión automáticamente y no podrás volver a ingresar. ¿Deseas continuar?";
                }

                const result = await Swal.fire({
                    title: 'Confirmación',
                    html: mensajeConfirmacion,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Continuar',
                    cancelButtonText: 'Cancelar'
                });

                if (result.isConfirmed) {
                    const response = await fetch(`/usuarios/toggle-estado/${documento}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json',
                        },
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Error ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Actualizar el estado en la tabla
                        const fila = document.querySelector(`.toggle-estado[data-documento="${documento}"]`).closest('tr');
                        const estadoCelda = fila.querySelector('td:nth-child(5)');
                        
                        if (data.is_active) {
                            estadoCelda.innerHTML = '<span class="text-green-600">Activo</span>';
                            fila.querySelector('.toggle-estado').innerHTML = '<i class="fas fa-ban"></i> Desactivar';
                            fila.querySelector('.toggle-estado').className = 'toggle-estado bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600';
                        } else {
                            estadoCelda.innerHTML = '<span class="text-red-600">Inactivo</span>';
                            fila.querySelector('.toggle-estado').innerHTML = '<i class="fas fa-check"></i> Activar';
                            fila.querySelector('.toggle-estado').className = 'toggle-estado bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600';
                        }
                        
                        // Mostrar mensaje de éxito
                        await Swal.fire({
                            icon: 'success',
                            title: '¡Éxito!',
                            text: data.message,
                            confirmButtonText: 'Aceptar'
                        });
                        
                        // Si se desactivó a sí mismo, redirigir al login
                        if (esUsuarioActual && !data.is_active) {
                            window.location.href = "{% url 'logout' %}";
                        }
                    } else {
                        throw new Error(data.message || 'Error al cambiar el estado');
                    }
                }
            } catch (error) {
                console.error('Error al cambiar estado:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'No se pudo cambiar el estado del usuario',
                    confirmButtonText: 'Entendido'
                });
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Botón nuevo usuario
            document.getElementById('btnNuevoUsuario').addEventListener('click', function(e) {
                e.preventDefault();
                resetForm();
                abrirModal();
            });

            // Inicializar event listeners
            asignarEventListeners();

            // Submit del formulario
            document.getElementById('usuarioForm').addEventListener('submit', function(e) {
                e.preventDefault();
                enviarFormulario();
            });

            // Cerrar modal al hacer clic fuera
            window.addEventListener('click', function(e) {
                if (e.target === document.getElementById('usuarioModal')) {
                    cerrarModal();
                }
            });

            // Cerrar modal con tecla Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    cerrarModal();
                }
            });
        });

        // Control del menú hamburguesa para móviles
document.getElementById('mobileMenuBtn').addEventListener('click', function() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    
    // Alternar visibilidad del sidebar
    sidebar.classList.toggle('-translate-x-full');
    
    // Alternar visibilidad del overlay
    overlay.classList.toggle('opacity-0');
    overlay.classList.toggle('pointer-events-none');
});

// Cerrar menú al hacer clic en el overlay
document.getElementById('overlay').addEventListener('click', function() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    
    sidebar.classList.add('-translate-x-full');
    overlay.classList.add('opacity-0');
    overlay.classList.add('pointer-events-none');
});

// Cerrar menú al hacer clic en un enlace (para móviles)
document.querySelectorAll('#sidebar a').forEach(link => {
    link.addEventListener('click', function() {
        if (window.innerWidth < 768) { // Solo para móviles
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('opacity-0');
            overlay.classList.add('pointer-events-none');
        }
    });
});
    </script>
</body>
</html>